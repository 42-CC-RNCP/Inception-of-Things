# Part1 K3s and Vagrant

In this practice we will use Vagrant to create a local K3s cluster with 1 server and 1 worker node.

## Vagrant

Vagrant is a tool for building and managing virtualized development environments. It allows you to define a virtual machine configuration in a single file, which can be versioned and shared.

### Vagrantfile

Basic vagrantfile structure:

```ruby
Vagrant.configure("2") do |config|
    # In the root level of the Vagrantfile, you can define global settings

    # config.vm.box: The base box to use for the virtual machine
    config.vm.box = "debian/bookworm64"  # Example base box
    
    # config.vm.provider: The provider to use for the virtual machine (e.g., VirtualBox, VMware, etc.)
    config.vm.provider "virtualbox" do |vb|
        # in the provider block, you can define provider-specific settings
        # if the provider setting be defined in the root level, it will be applied to all machines
        vb.memory = "1024"
        vb.cpus = 2
    end

    # config.vm.define: You can define multiple virtual machines with different configurations
    config.vm.define "server" do |s_vm|
        # This block defines a virtual machine named "server"

        s_vm.vm.hostname = "k3s-server"

        # For the network configuration, you can define private networks, public networks, etc.
        s_vm.vm.network "private_network", ip: "192.168.56.10"
    end
end
```

### Synced Folder

Vagrant allows you to sync folders between the host and the guest machine. This is useful for sharing files and directories.

You can define synced folders in the Vagrantfile using the `config.vm.synced_folder` method. For example:

In default, Vagrant syncs the current directory (where the Vagrantfile is located) to the `/vagrant` directory on the guest machine. If you want to change this behavior or add additional synced folders, you can do so like this:

```ruby
config.vm.synced_folder "./data", "/vagrant_data"

# disable the default synced folder
config.vm.synced_folder ".", "/vagrant", disabled: true
```

This will sync the `./data` directory on the host machine to the `/vagrant_data` directory on the guest machine.

### Useful Commands

- `vagrant up` - Start the virtual machine(s) defined in the Vagrantfile.
- `vagrant halt` - Stop the virtual machine(s).
- `vagrant destroy` - Stop and remove the virtual machine(s).
- `vagrant ssh <machine>` - SSH into the virtual machine.
- `vagrant status` - Show the status of the virtual machine(s).
- `vagrant reload` - Restart the virtual machine(s) and apply any changes made to the Vagrantfile.

## K3s

K3s is a lightweight Kubernetes distribution.

Master/Server node is the main node that runs the Kubernetes control plane components, such as the API server, controller manager, and scheduler.

Worker node is a node that runs the applications and workloads in the cluster. It communicates with the master node to receive instructions and report status.

### Installation

To install K3s on the server node, you can use the following command:

```bash
curl -sfL https://get.k3s.io | sh -
```

To install K3s on the worker node, you need to join it to the cluster using the token generated by the server node. You can find the token in the file `/var/lib/rancher/k3s/server/node-token` on the server node.

To get the token, you can run the following command on the server node:

```bash
cat /var/lib/rancher/k3s/server/node-token
```
Then, on the worker node, you can run the following command to join the cluster:

```bash
curl -sfL https://get.k3s.io | K3S_URL=https://<server-ip>:6443 K3S_TOKEN=<token> sh -
```
